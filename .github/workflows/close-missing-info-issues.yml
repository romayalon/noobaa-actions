name: Close missing info issues

on:
  schedule:
    - cron: '*/2 * * * *'  # Runs every 2 minutes
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  close-missing-info-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Close missing info issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          closure_comment = "This issue is being closed because it has been labeled 'missing info' for more than a week. Please provide the requested information and reopen the issue if necessary."
          echo $closure_comment
          missing_info_issues = gh issue list --label "missing info" --state open --json number,labels,createdAt | jq -r '.[]
          echo $missing_info_issues
          missing_info_issues_older_than_a_week = missing_info_issues | select(((now - ( .createdAt | fromdateiso8601)) / 86400) > 7) | .number'
          echo $missing_info_issues_older_than_a_week
          missing_info_issues_older_than_a_week | while read -r issueNumber; do gh issue close "$issueNumber" --comment closure_comment; done
